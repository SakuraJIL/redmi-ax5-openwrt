name: Build Redmi AX5 ImmortalWrt (Minimal DNS)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo docker image prune -a -f

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev \
          libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          libc6-dev-i386

      - name: Clone ImmortalWrt
        run: |
          git clone -b openwrt-23.05 https://github.com/immortalwrt/immortalwrt.git

      - name: Update Feeds
        run: |
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate Config (Minimal Bypass Router)
        run: |
          cd immortalwrt
          echo "
          CONFIG_TARGET_ipq60xx=y
          CONFIG_TARGET_ipq60xx_generic=y
          CONFIG_TARGET_ipq60xx_generic_DEVICE_xiaomi_ax5=y

          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-i18n-base-zh-cn=y

          CONFIG_PACKAGE_adguardhome=y
          CONFIG_PACKAGE_dnsmasq-full=y

          # Disable WiFi
          CONFIG_PACKAGE_kmod-ath11k=n
          CONFIG_PACKAGE_kmod-mac80211=n
          CONFIG_PACKAGE_wpad-basic=n

          # Disable PPP
          CONFIG_PACKAGE_ppp=n
          CONFIG_PACKAGE_ppp-mod-pppoe=n

          # Disable IPv6
          CONFIG_IPV6=n

          " > .config

          make defconfig

      - name: Set Default IP to 192.168.5.2
        run: |
          cd immortalwrt
          sed -i 's/192.168.1.1/192.168.5.2/g' package/base-files/files/bin/config_generate

      - name: Download
        run: |
          cd immortalwrt
          make download -j8

      - name: Compile
        run: |
          cd immortalwrt
          make -j2

      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: Redmi-AX5-ImmortalWrt-Minimal
          path: immortalwrt/bin/targets/ipq60xx/generic/
